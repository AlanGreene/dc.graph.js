<!DOCTYPE html>

<html>
<head>
  <title>Single file viewer</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" type="text/css" href="../css/dc.graph.css"/>
  <link rel="stylesheet" type="text/css" href="../css/dc.css"/>
  <link rel="stylesheet" type="text/css" href="../css/d3-tip/example-styles.css"/>

  <script type="text/javascript" src="../js/d3.js"></script>
  <script type="text/javascript" src="../js/crossfilter.js"></script>
  <script type="text/javascript" src="../js/dc.js"></script>
  <script type="text/javascript" src="../js/d3-tip/index.js"></script>

  <script type="text/javascript" src="../js/jquery.js"></script>
  <script type="text/javascript" src="../js/lodash.js"></script>

  <script type="text/javascript" src="../js/cola.js"></script>
  <script type="text/javascript" src="../js/dc.graph.js"></script>

  <script type="text/javascript" src="../js/flat-group.js"></script>
  <script type="text/javascript" src="../js/querystring.js"></script>
  <script type="text/javascript" src="../js/runner.js"></script>

  <style type="text/css">
    body {
      overflow: hidden;
    }
  </style>

</head>
<body>

  <div id="graph" class="chart"></div>
  <script type="text/javascript">

    var file = "router-farm1.json";
    var tables_file = "temp.json";
    var diagram = dc_graph.diagram('#graph');
    var pagestatus = 0;

    diagram
        .width($(window).width())
        .height($(window).height())

        // aesthetics
        .nodeStrokeWidthAccessor(0) // turn off outlines

	.nodeFillAccessor(function(kv) {
            // calculate colors from kv.value somehow
            //return kv.value.name.length%2 ? '#2E54A2' : '#ED3F00';
             switch(kv.value.status) {
             	case 'offline': return 'grey'
              	default: return '#2E9AFE';
              }
        })
        .nodeLabelFillAccessor('white')
        .nodeTitleAccessor(null) // deactivate basic tooltips
        .edgeArrowheadAccessor(draw_arrows ? 'vee' : null)
        .timeLimit(5000)
        .showLayoutSteps(false)
        .transitionDuration(0)
        .lengthStrategy('individual')
        .edgeDistanceAccessor(function(kv) {
            if(/Backbone/.test(kv.value.sourcename) || /Backbone/.test(kv.value.targetname))
                return 150;
            else
                return 100;
        })
	.on('end', function() {
            runner.endStep();
        });

    function nocache_query() {
        return '?nocache=' + Date.now();
    }

    var qs = querystring.parse();
    var draw_arrows = qs.arrows==='true'; // example of using query string parameter
    var tip = null;

    function do_load(k) {
        dc_graph.load_graph(file + nocache_query(), function(error, data) {
            if(error) {
                console.log(error);
                return;
            }
            var edges = flat_group.make(data.links, function(d) {
                return d.sourcename + '-' + d.targetname + (d.par ? ':' + d.par : '');
            }),
                nodes = flat_group.make(data.nodes, function(d) { return d.name; });
            diagram
                .nodeDimension(nodes.dimension).nodeGroup(nodes.group)
                .edgeDimension(edges.dimension).edgeGroup(edges.group);

            k();
            if(!tip) {
                tip = d3.tip().attr('class', 'd3-tip').html(function(N) {
                    //parse the string
                    var res = N.split("#");
                    var node_name = res[0];
                    var DispString = ""
                    switch (node_name){
                    case "Backbone Routers":
                        DispString = "Routers in the backbone network";
                        break;
                    case "CVM-NY":
                    case "CVM-LA":
                    case "CVM-DC":
                        DispString = "<pre> RD    PREFIX    NEXTHOP</pre>";
                        for (i=1; i < res.length-1; i++){
                            DispString += res[i] + "<br>";
                            DispString += res[res.length-1];
                        }
                        break;
                    case "PVM-LA-FEDEX":
                    case "PVM-LA-UPS":
                    case "PVM-NY-FEDEX":
                    case "PVM-NY-UPS":
                    case "PVM-DC-FEDEX":
                    case "PVM-DC-UPS":
                        DispString = "<pre>PREFIX    NEXTHOP</pre>";
                        for (i=1; i < res.length-1; i++){
                            DispString += res[i] + "<br>";
                            DispString += res[res.length-1];
                        }
                        break;
                    case "CE-LA-FEDEX":
                    case "CE-LA-UPS":
                    case "CE-NY-FEDEX":
                    case "CE-NY-UPS":
                    case "CE-DC-FEDEX":
                    case "CE-DC-UPS":
                        DispString = "<pre>PREFIX    NEXTHOP</pre>";
                        DispString += "<pre>  *     192.168.0.22";
                        break;
                    default:
                        DispString = "Node not found";
                    }
                    //for (i = 1; i < res.length; i++){
                    //	dispString += res[i] + "<br>";
                    //}
                    //dispString += res[res.length]
                    // demonstrating html tooltips
                    return "<em>" + DispString + "</em>";
                });
                diagram.svg().call(tip)
            }
            diagram.selectAll('g.node')
                .on('mouseover.foo', function(d){
		    //store the current event
                    var e = d3.event;
		    lockSet();
                    // this would be an ajax call
                    d3.json("http://135.197.224.250:28017/router_farm/posts/", function(error, respjson){
                        //restore the current event so d3-tip knows the target
                        d3.event = e;
                        var node_name = d.orig.value.name;
			//tip.hide();
			var displayStr = node_name + "#" +respjson["rows"][0][node_name];
			tip.show(displayStr);
                    })
                })
                //.on("mouseleave", lockReset)
		.on('mouseout.foo', function(d){
			tip.hide();
			lockReset();
		});
            $(window).resize(function() {
                diagram
                    .width($(window).width())
                    .height($(window).height());
            });
        });
    }

    function lockReset(){
	pagestatus = 0;
	console.log(String(pagestatus));
    }

    function lockSet(){
	pagestatus = 1;
	console.log(String(pagestatus));
    }

    function init() {
        console.log("In init");
	do_load(function() {
            diagram.render();
        })
    }

    function step() {
	console.log("In Step");
		do_load(function() {
            		if (pagestatus == 0){
				console.log("Redrawing!")
				diagram.redraw();
			}
        	})
    }

    var runner = make_runner(init, step, 5000);
    runner.start();

    </script>

</body>
