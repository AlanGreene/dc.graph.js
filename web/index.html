<html>
<head>
<title>Thing</title>
</head>

<body>
<h1>Thing.</h1>
<p>An example of drawing a graph from crossfilter data.</p>

<div id="graph"></div>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.11/crossfilter.js"></script>
<script type="text/javascript" src="http://dc-js.github.io/dc.js/js/dc.js"></script>
<!-- not right, need grunt web -->
<script type="text/javascript" src="../dc.graph.js">

  var diagram = dc_graph.diagram('#graph');

  d3.csv("qfs.json", function(error, data) {
      var edge_ndx = crossfilter(data.links),
          node_ndx = crossfilter(data.nodes);

      // these are just identity dimension/groups, with unique keys
      // more complex node/edge generation is possible, but it is more likely that
      // grouping will happen in other kinds of charts
      var nodeDim = node_ndx.dimension(function(d) { return d.name; }),
          edgeDim = edge_ndx.dimension(function(d) { return d.sourcename + '->' + d.targetname; }),
          nodeGroup = nodeDim.group().reduce(function(p, v) { return v; }, function() { return null; },function() { return null; }),
          edgeGroup = nodeDim.group().reduce(function(p, v) { return v; }, function() { return null; },function() { return null; });

      // reuse defaults out of laziness
      var constrainer = diagram.constrainer();
      constrainer.edge_enter = function(es, cs, nm) {
          es.each(function(e) {
              var s = nm[e.value.source], t = nm[e.value.target];
              if(s.class === 'Client' && t.class === 'ChunkServer') {
                  cs[e.key] = {
                      left: s.id,
                      right: t.id,
                      axis: 'y',
                      gap: 100
                  }
              }
          });
          return this;
      }

      diagram.width(700).height(500)
          .nodeDim(nodeDim).nodeGroup(nodeGroup)
          .edgeDim(edgeDim).edgeGroup(edgeGroup)
          .sourceAccessor(function(e) { return e.sourcename; })
          .targetAccessor(function(e) { return e.targetname; })
          .constrainer(constrainer);
  });

</script>
